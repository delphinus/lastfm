"use strict";if(!Date.prototype.strftime){Date.prototype.strftime=function(){return this.toString()}}if(!window.console){window.console={log:$.noop()}}window.lfmObjs=[];(function(b){var c=function(j){if(window.TEST_MODE&&window.console){console.log(j)}else{return false}},g=function(k,j){this.init(k,b(j));this.updatetracks()};g.prototype={defaults:{queryURL:"http://ws.audioscrobbler.com/2.0/?callback=?",username:"delphinus_iddqd",apikey:"fca0142adfe95a7fb622a63d28b7d1a5",number:10,artSize:"medium",noart:"./images/noartwork.gif",showArtistArt:true,autoUpdate:true,updateInterval:"10m",drawDelay:true,showInterval:500,onComplete:b.noop()},init:function(n,q){var m,l,p,k,o=-1,n=b.extend({},this.defaults,n);n.updateInterval=e(n.updateInterval);while(m=window.lfmObjs[++o]){if(q.hasClass(m.name)){break}}if(o<window.lfmObjs.length){for(k in m.timer){clearInterval(m.timer[k])}if(m.$timerLabel){m.$timerLabel.remove()}l=m.name;p=m.item;window.lfmObjs[o]=this}else{l="LFM-"+b.now();q.addClass(l);p=q.html();window.lfmObjs.push(this)}q.children().remove();b.extend(this,{$container:q,$timerLabel:null,name:l,item:p,options:n,updating:false,lastRemoved:null,t:{},tracks:[],timer:{main:null,sub:null},imgSize:n.artSize=="small"?0:n.artSize=="medium"?1:n.artSize=="large"?2:0})},updatetracks:function(){var k;this.t=d(this.options.updateInterval);if(this.options.autoUpdate){var j;if(!this.$timerLabel){var j=b("<div/>").addClass("lfm_update").appendTo(this.$container.parent());j.attr({id:"LFM_timer-"+b.now()});this.$timerLabel=j}if(!this.timer.sub){this.timer.sub=setInterval(i(function(){var l=parseInt(this.t.next-b.now()/1000),m=l<=0?"loading...":new Date(this.t.next*1000).strftime("next update: %r ")+"( "+l+"s )";this.$timerLabel.text(m)},this),1000)}this.timer.main=setTimeout(i(this.updatetracks,this),this.options.updateInterval*1000)}if(this.updating){return}else{this.updating=true}b.getJSON(this.options.queryURL,{method:"user.getrecenttracks",format:"json",user:this.options.username,api_key:this.options.apikey,limit:this.options.number,nowplaying:true,from:this.tracks.length>0?this.tracks[this.tracks[0].uts==0?1:0].uts:0},i(function(l){if(l.error){return this.handleError(l)}if(b.isArray(l.recenttracks.track)){if(this.tracks.length>0&&this.tracks[0].uts==0){this.tracks.shift().$item.remove()}b.each(l.recenttracks.track.reverse(),i(this.displaytrack,this))}this.updateTime()},this)).complete(i(function(){this.updating=false},this))},displaytrack:function(p,m){var o,r,n,t,j,l=this.options.drawDelay?this.options.showInterval*p:0,s=false,k={url:a(m.url),song:m.name,artist:m.artist["#text"],album:m.album["#text"],uts:m["@attr"]&&m["@attr"].nowplaying?0:m.date.uts};k.$item=b(this.item).prependTo(this.$container).hide();b(".lfm_song",k.$item).text(k.song);b(".lfm_artist",k.$item).text(k.artist);b(".lfm_album",k.$item).text(k.album);b("a",k.$item).attr({href:k.url,title:"Listen to "+k.name+" on Last.FM",target:"_blank"});if(this.tracks.length+1>this.options.number){this.tracks.pop().$item.delay(l).remove()}if(l){k.$item.delay(l).fadeIn("slow")}else{k.$item.show()}try{k.art=a(m.image[this.imgSize]["#text"]);if(!k.art){throw 0}}catch(q){k.art=this.options.noart;s=true}t=b(".lfm_art",k.$item);if(s&&this.options.showArtistArt){b.getJSON(this.options.queryURL,{method:"artist.getimages",format:"json",artist:k.artist,api_key:this.options.apikey,limit:1},f(this.drawimage,this)(t))}else{h(t,k.art,k.album)}this.tracks.unshift(k);if(p==this.options.number-1){this.options.onComplete.call(this)}},updateTime:function(){b.each(this.tracks,i(function(l,j){var n,m,k;if(j.uts==0){m=-1}else{n=new Date(j.uts*1000);m=this.t.now-j.uts;k=parseInt(m/60)}b(".lfm_datetime",j.$item).text(m<0?"now playing":m<600?"just listened":m<3600?k+" minute"+(k==1?"":"s")+" ago":j.uts>=this.t.today?n.strftime("Today %I:%M %p"):j.uts>=this.t.yesterday?n.strftime("Yesterday %I:%M %p"):j.uts>=this.t.lastWeek?n.strftime("%A %I:%M %p"):j.uts>=this.t.thisYear?n.strftime("%m/%d %I:%M %p"):j.uts>=this.t.lastYear?n.strftime("Last Year %m/%d %I:%M %p"):n.strftime("%Y/%m/%d %I:%M %p"))},this))},drawimage:function(j,n){var l=0,m,k;try{m=n.images.image.sizes.size;while(m[l].name.indexOf(this.options.artSize,0)<0){l++}k=m[l]["#text"];h(j,a(k),n.images["@attr"].artist)}catch(o){h(j,this.options.noart)}},handleError:function(k){this.$container.children().remove();var j=b(this.item).prependTo(this.$container);b(".lfm_song",j).text("error: "+k.error);b(".lfm_artist",j).text("message: "+k.message)}};function e(j){j=j+"";return(j.match(/(\d+)h$/i)?RegExp.$1*3600:j.match(/(\d+)m$/i)?RegExp.$1*60:j.match(/(\d+)s$/i)?RegExp.$1*1:j.match(/(\d+)/)?RegExp.$1*1:600)}function d(m){var l=new Date(),o=l.getTime(),n={now:l,today:new Date(o),yesterday:new Date(o-86400*1000),lastWeek:new Date(o-6*86400*1000),thisYear:new Date(o),lastYear:new Date(o-365*86400),next:new Date(o+m*1000)},j;b.each("today yesterday lastWeek thisYear lastYear".split(/\s/),function(){n[this].setHours(0);n[this].setMinutes(0);n[this].setSeconds(0)});b.each("thisYear lastYear".split(/\s/),function(){n[this].setMonth(0);n[this].setDate(1)});for(j in n){n[j]=n[j].getTime()/1000}return n}function a(j){return(j+"").replace(/\0/g,"0").replace(/\\([\\'"])/g,"$1")}function h(j,k,l){b("<img/>").attr({src:k,alt:l?l:null}).appendTo(j)}function i(k,j){return function(){return k.apply(j,arguments)}}function f(l,k){k=k||window;if(l.length==0){return l}var j=function(m){if(m.length>=l.length){return l.apply(k,m)}return function(){return j(m.concat(Array.prototype.slice.call(arguments)))}};return j([])}b.fn.lastFM=function(j){b(this).each(function(){new g(j,this)})}})(jQuery);