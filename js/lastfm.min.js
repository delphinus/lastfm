"use strict";if(!Date.prototype.strftime){Date.prototype.strftime=function(){return this.toString()}}if(!window.console){window.console={log:$.noop}}if(!$.noop){$.noop=function(){}}if(!$.now){$.now=function(){return new Date().getTime()}}window.lfmObjs=[];(function(b){var c=function(k){if(window.TEST_MODE&&window.console){console.log(k)}else{return false}},g=b.fn.jquery.replace(/\.(?=\d*)/,""),h=function(l,k){this.init(l,b(k));this.updatetracks()};h.prototype={defaults:{queryURL:"http://ws.audioscrobbler.com/2.0/?callback=?",username:"delphinus_iddqd",apikey:"fca0142adfe95a7fb622a63d28b7d1a5",number:10,artSize:"medium",noart:"./images/noartwork.gif",showArtistArt:true,autoUpdate:true,updateInterval:"10m",drawDelay:true,showInterval:500,onComplete:b.noop},init:function(n,q){var m,l,p,k,o=-1,n=b.extend({},this.defaults,n);n.updateInterval=e(n.updateInterval);while(m=window.lfmObjs[++o]){if(q.hasClass(m.name)){break}}if(o<window.lfmObjs.length){for(k in m.timer){clearInterval(m.timer[k])}if(m.$timerLabel){m.$timerLabel.remove()}l=m.name;p=m.item;window.lfmObjs[o]=this}else{l="LFM-"+b.now();q.addClass(l);p=q.html();window.lfmObjs.push(this)}q.children().remove();b.extend(this,{$container:q,$timerLabel:null,name:l,item:p,options:n,updating:false,lastRemoved:null,t:{},tracks:[],timer:{main:null,sub:null},imgSize:n.artSize=="small"?0:n.artSize=="medium"?1:n.artSize=="large"?2:0})},updatetracks:function(){var l;this.t=d(this.options.updateInterval);if(this.options.autoUpdate){var k;if(!this.$timerLabel){var k=b("<div/>").addClass("lfm_update").appendTo(this.$container.parent());k.attr({id:"LFM_timer-"+b.now()});this.$timerLabel=k}if(!this.timer.sub){this.timer.sub=setInterval(j(function(){var m=parseInt(this.t.next-b.now()/1000),n=m<=0?"loading...":new Date(this.t.next*1000).strftime("next update: %r ")+"( "+m+"s )";this.$timerLabel.text(n)},this),1000)}this.timer.main=setTimeout(j(this.updatetracks,this),this.options.updateInterval*1000)}if(this.updating){return}else{this.updating=true}b.ajax({url:this.options.queryURL,dataType:"jsonp",data:{method:"user.getrecenttracks",format:"json",user:this.options.username,api_key:this.options.apikey,limit:this.options.number,nowplaying:true,from:this.tracks.length>0?this.tracks[this.tracks[0].uts==0?1:0].uts:0},success:j(function(m){if(m.error){return this.handleError(m)}if(b.isArray(m.recenttracks.track)){if(this.tracks.length>0&&this.tracks[0].uts==0){this.tracks.shift().$item.remove()}b.each(m.recenttracks.track.reverse(),j(this.displaytrack,this))}this.updateTime()},this),complete:j(function(){this.updating=false},this)})},displaytrack:function(q,n){var p,s,o,v,k,u,m=g<1.4&&this.options.drawDelay?this.options.showInterval*q:0,t=false,l={url:a(n.url),song:n.name,artist:n.artist["#text"],album:n.album["#text"],uts:n["@attr"]&&n["@attr"].nowplaying?0:n.date.uts};l.$item=b(this.item).prependTo(this.$container).hide();b(".lfm_song",l.$item).text(l.song);b(".lfm_artist",l.$item).text(l.artist);b(".lfm_album",l.$item).text(l.album);b("a",l.$item).attr({href:l.url,title:"Listen to "+l.name+" on Last.FM",target:"_blank"});if(this.tracks.length+1>this.options.number){u=this.tracks.pop().$item;if(m){u.delay(m).remove()}else{u.remove()}}if(m){l.$item.delay(m).fadeIn("slow")}else{l.$item.show()}try{l.art=a(n.image[this.imgSize]["#text"]);if(!l.art){throw 0}}catch(r){l.art=this.options.noart;t=true}v=b(".lfm_art",l.$item);if(t&&this.options.showArtistArt){b.getJSON(this.options.queryURL,{method:"artist.getimages",format:"json",artist:l.artist,api_key:this.options.apikey,limit:1},f(this.drawimage,this)(v))}else{i(v,l.art,l.album)}this.tracks.unshift(l);if(q==this.options.number-1){this.options.onComplete.call(this)}},updateTime:function(){b.each(this.tracks,j(function(m,k){var o,n,l;if(k.uts==0){n=-1}else{o=new Date(k.uts*1000);n=this.t.now-k.uts;l=parseInt(n/60)}b(".lfm_datetime",k.$item).text(n<0?"now playing":n<600?"just listened":n<3600?l+" minute"+(l==1?"":"s")+" ago":k.uts>=this.t.today?o.strftime("Today %I:%M %p"):k.uts>=this.t.yesterday?o.strftime("Yesterday %I:%M %p"):k.uts>=this.t.lastWeek?o.strftime("%A %I:%M %p"):k.uts>=this.t.thisYear?o.strftime("%m/%d %I:%M %p"):k.uts>=this.t.lastYear?o.strftime("Last Year %m/%d %I:%M %p"):o.strftime("%Y/%m/%d %I:%M %p"))},this))},drawimage:function(k,o){var m=0,n,l;try{n=o.images.image.sizes.size;while(n[m].name.indexOf(this.options.artSize,0)<0){m++}l=n[m]["#text"];i(k,a(l),o.images["@attr"].artist)}catch(p){i(k,this.options.noart)}},handleError:function(l){this.$container.children().remove();var k=b(this.item).prependTo(this.$container);b(".lfm_song",k).text("error: "+l.error);b(".lfm_artist",k).text("message: "+l.message)}};function e(k){k=k+"";return(k.match(/(\d+)h$/i)?RegExp.$1*3600:k.match(/(\d+)m$/i)?RegExp.$1*60:k.match(/(\d+)s$/i)?RegExp.$1*1:k.match(/(\d+)/)?RegExp.$1*1:600)}function d(n){var m=new Date(),p=m.getTime(),o={now:m,today:new Date(p),yesterday:new Date(p-86400*1000),lastWeek:new Date(p-6*86400*1000),thisYear:new Date(p),lastYear:new Date(p-365*86400),next:new Date(p+n*1000)},l;b.each("today yesterday lastWeek thisYear lastYear".split(/\s/),function(){o[this].setHours(0);o[this].setMinutes(0);o[this].setSeconds(0)});b.each("thisYear lastYear".split(/\s/),function(){o[this].setMonth(0);o[this].setDate(1)});for(l in o){o[l]=o[l].getTime()/1000}return o}function a(k){return(k+"").replace(/\0/g,"0").replace(/\\([\\'"])/g,"$1")}function i(k,l,m){b("<img/>").attr({src:l,alt:m?m:null}).appendTo(k)}function j(l,k){return function(){return l.apply(k,arguments)}}function f(m,l){l=l||window;if(m.length==0){return m}var k=function(n){if(n.length>=m.length){return m.apply(l,n)}return function(){return k(n.concat(Array.prototype.slice.call(arguments)))}};return k([])}b.fn.lastFM=function(k){b(this).each(function(){new h(k,this)})}})(jQuery);